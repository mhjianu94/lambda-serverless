name: Deploy to AWS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering from GitHub UI

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  NODE_VERSION: '20.x'

jobs:
  deploy:
    name: Deploy CDK Stack
    runs-on: ubuntu-latest
    environment: aws-mhj
    # Only deploy on push when commit message contains [deploy]; always run when triggered manually
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy]')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd infrastructure && npm ci && cd ..

      - name: Build TypeScript
        run: npm run build

      - name: Build Lambda (TypeORM users API)
        run: npm run build:lambda

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install CDK globally
        run: npm install -g aws-cdk

      - name: Bootstrap CDK (if needed)
        run: |
          # Bootstrap CDK - this is idempotent, safe to run multiple times
          cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} || echo "Bootstrap may have failed or already exists"
        continue-on-error: true

      - name: CDK Synth
        run: cd infrastructure && cdk synth
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          LAMBDA_CODE_PATH: dist/lambda

      - name: CDK Deploy
        run: cd infrastructure && cdk deploy --all --require-approval never
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          LAMBDA_CODE_PATH: dist/lambda

      - name: Run DB migrations
        run: |
          MIGRATION_FN=$(aws cloudformation list-exports --region ${{ env.AWS_REGION }} --query "Exports[?Name=='ApiDbService-MigrationFunctionName'].Value" --output text 2>/dev/null || true)
          if [ -n "$MIGRATION_FN" ]; then
            echo "Invoking migration Lambda: $MIGRATION_FN"
            aws lambda invoke --function-name "$MIGRATION_FN" --region ${{ env.AWS_REGION }} --log-type Tail .migration-out.json
            cat .migration-out.json
          else
            echo "Migration Lambda export not found (ApiDbService may not be deployed), skipping."
          fi
        continue-on-error: true

      - name: Output deployment info
        run: |
          echo "Deployment completed successfully!"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Account: ${{ secrets.AWS_ACCOUNT_ID }}"

